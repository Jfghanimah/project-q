<!-- edit_profile.html -->
{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-5">
  <div class="card bg-dark text-light">
    <div class="card-header">
      <h2 class="mb-0">Edit Profile</h2>
    </div>
    <div class="card-body">
      <!-- Success/Error message containers -->
      <div id="message-container" class="alert" style="display: none;"></div>
      <form id="edit-profile-form" method="post" action="{% url 'rest_user_details' %}" enctype="multipart/form-data">
        {% csrf_token %}
        {% for field in form %}
          <div class="mb-3">
            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
            {{ field }}
            {% if field.help_text %}
              <div class="form-text text-muted">{{ field.help_text }}</div>
            {% endif %}
            {% if field.errors %}
              <div class="text-danger small">{{ field.errors }}</div>
            {% endif %}
          </div>
        {% endfor %}
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('edit-profile-form');
  const messageContainer = document.getElementById('message-container');

  form.addEventListener('submit', function(event) {
    event.preventDefault();

    // Clear previous messages
    messageContainer.style.display = 'none';
    messageContainer.textContent = '';
    messageContainer.classList.remove('alert-success', 'alert-danger');

    const formData = new FormData(form);

    fetch(form.action, {
      method: 'PATCH', // Use PATCH for partial updates
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        // No 'Content-Type' header for FormData, browser sets it
      },
      body: formData
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
      if (status === 200) {
        messageContainer.textContent = 'Profile updated successfully!';
        messageContainer.classList.add('alert-success');
        messageContainer.style.display = 'block';
        // Optionally, redirect after a delay
        setTimeout(() => {
          window.location.href = "{% url 'profile' user.username %}";
        }, 1500);
      } else {
        let errorHtml = '<ul>';
        for (const field in body) {
          body[field].forEach(error => {
            errorHtml += `<li>${field}: ${error}</li>`;
          });
        }
        errorHtml += '</ul>';
        messageContainer.innerHTML = errorHtml;
        messageContainer.classList.add('alert-danger');
        messageContainer.style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      messageContainer.textContent = 'An unexpected error occurred.';
      messageContainer.classList.add('alert-danger');
      messageContainer.style.display = 'block';
    });
  });
});
</script>
{% endblock %}
